#include "wasm4.h"
#include <string.h>
#include <math.h>
#include <stdbool.h>

#define marios_len 64
#define one_mario 16

int pixPosColor[4];
int a;
int old_a;
int b;
int old_b;
int sprite;
int old_sprite;
int distancia;
bool pulo;
bool mover;
int contador;
double statex1;
double statex2;
double inimigos1[10][3];
int inimigosestados;
int movinim;
bool morte;
bool morteInimigo;

uint8_t gamepad;
uint8_t previousGamepad;
uint8_t pressedThisFrame;// = gamepad & (gamepad ^ previousGamepad);
const uint8_t marios[] = {0x00,0x00,0x00,0x00,0xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xfc,0x0a,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x2a,0xaa,0xa0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0a,0xa0,0x00,0x28,0xef,0xa8,0x00,0x00,0x02,0xa0,0x00,0x00,0x02,0xa0,0x00,0x03,0x2a,0xa8,0xc0,0x2b,0xfe,0xba,0x00,0x00,0xaa,0xa8,0x00,0x00,0xaa,0xa8,0x00,0x0f,0xbb,0xee,0xf0,0x0a,0xaf,0xfa,0x00,0x00,0x3b,0xea,0x00,0x00,0x3b,0xea,0x00,0x0e,0xaf,0xfa,0xb0,0x02,0xff,0xf0,0x00,0x00,0xff,0xae,0x80,0x00,0xff,0xae,0x80,0x02,0xba,0xae,0x80,0x00,0x9a,0x6a,0x00,0x00,0xeb,0xfe,0x80,0x00,0xeb,0xfe,0x80,0x00,0xbf,0xfe,0x00,0x20,0x69,0x6a,0xb0,0x00,0x3f,0xfc,0x00,0x00,0x3f,0xfc,0x00,0x00,0xa7,0xda,0x00,0x29,0x55,0x54,0xf0,0x00,0x02,0x6a,0x80,0x00,0x02,0x6a,0x00,0x08,0x56,0x95,0x20,0x29,0x55,0x56,0x30,0x03,0xfa,0x6a,0xbc,0x00,0x0a,0x6a,0x80,0x0a,0x95,0x56,0xa0,0x00,0x15,0x5a,0x80,0x03,0xe9,0x6a,0x3c,0x00,0x15,0x7e,0x80,0x0a,0x95,0x56,0xa0,0x00,0x00,0x50,0x80,0x00,0x81,0x55,0x40,0x00,0x15,0x5d,0x40,0x00,0x15,0x54,0x00,0x00,0x00,0x00,0x00,0x00,0xa5,0x55,0x60,0x00,0x0a,0x55,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xa5,0x01,0xa0,0x00,0x2a,0xa8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0a,0x80,0x00,0x02,0xa8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0xa0,0x00,0x00,0x02,0xa0,0x00,0x00,0x0a,0x80,0x00,0x00,0x02,0xa0,0x00,0x00,0xaa,0xa8,0x00,0x00,0xaa,0xa8,0x00,0x00,0x2a,0xaa,0x00,0x00,0x0a,0xaa,0x80,0x00,0x3b,0xea,0x00,0x00,0x3b,0xea,0x00,0x00,0xab,0xec,0x00,0x00,0x2a,0xfb,0x00,0x00,0xff,0xae,0x80,0x00,0xff,0xae,0x80,0x02,0xba,0xff,0x00,0x00,0xae,0xbf,0xc0,0x00,0xeb,0xfe,0x80,0x00,0xeb,0xfe,0x80,0x02,0xbf,0xeb,0x00,0x00,0xaf,0xfa,0xc0,0x00,0x3f,0xfc,0x00,0x00,0x3f,0xfc,0x00,0x00,0x3f,0xfc,0x00,0x00,0x0f,0xff,0x00,0x03,0xc9,0xaa,0x00,0x00,0x06,0x9a,0x00,0x00,0xa6,0x90,0x00,0x00,0x2a,0x98,0xf0,0x03,0xfa,0xaa,0xc0,0x00,0xa6,0x9a,0x80,0x02,0xa6,0x9a,0x00,0x00,0xea,0xab,0xf0,0x00,0x15,0x55,0xf0,0x03,0xa5,0x5b,0xc0,0x03,0xe5,0x5a,0xc0,0x03,0xd5,0x55,0x00,0x00,0x05,0x55,0x80,0x03,0xd5,0x57,0xc0,0x03,0xd5,0x57,0xc0,0x00,0x95,0x54,0x00,0x00,0x02,0x85,0xa0,0x00,0x28,0x28,0x00,0x00,0x28,0x28,0x00,0x02,0x94,0xa0,0x00,0x00,0x0a,0x80,0x20,0x00,0xa8,0x2a,0x00,0x00,0xa8,0x2a,0x00,0x02,0x00,0xa8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0a,0x80,0xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x2a,0xaa,0xa0,0x00,0x00,0x00,0x00,0x00,0x02,0xa0,0x00,0x00,0x02,0xa0,0x00,0x00,0xab,0xec,0xa0,0x00,0x00,0x00,0x00,0x00,0x0a,0xaa,0x80,0x00,0x0a,0xaa,0x80,0x02,0xba,0xff,0xa0,0x00,0x00,0x00,0x00,0x00,0x2a,0xfb,0x00,0x00,0x2a,0xfb,0x00,0x02,0xbf,0xea,0x80,0x00,0x00,0x00,0x00,0x00,0xae,0xbf,0xc0,0x00,0xae,0xbf,0xc0,0x00,0x3f,0xfe,0x00,0x00,0x00,0x00,0x00,0x00,0xaf,0xfa,0xc0,0x00,0xaf,0xfa,0xc0,0x02,0xa6,0x98,0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0xff,0x00,0x00,0x0f,0xff,0x00,0x3a,0xa5,0xa4,0x20,0x00,0x00,0x00,0x00,0x00,0x2a,0x60,0x00,0x00,0xaa,0x60,0x00,0x3c,0x55,0x55,0xa0,0x00,0x00,0x00,0x00,0x00,0xaa,0x68,0x00,0x0f,0xaa,0x6b,0xf0,0x32,0x55,0x55,0xa0,0x00,0x00,0x00,0x00,0x00,0xaf,0x55,0x00,0x0f,0x2a,0x5a,0xf0,0x0a,0x95,0x50,0x00,0x00,0x00,0x00,0x00,0x00,0x5d,0x55,0x00,0x00,0x55,0x50,0x80,0x08,0x14,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x15,0x68,0x00,0x02,0x55,0x56,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0a,0xaa,0x00,0x02,0x90,0x16,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0a,0xa0,0x00,0x00,0xa8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
const uint8_t enemies1[] = {0x0a,0xa8,0x0b,0xff,0x89,0xff,0xda,0xdf,0xde,0xbd,0xdf,0xaf,0x77,0xe2,0xff,0xe0,0x3f,0xf0};
const uint8_t castelo[] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x0a,0x00,0x00,0x00,0x00,0x00,0xa8,0x00,0x00,0x00,0x00,0x0a,0xa0,0x00,0x0c,0xcc,0xc0,0x40,0x33,0x33,0xff,0xfc,0x04,0x03,0xff,0xff,0xff,0xc0,0x40,0x3f,0xff,0xfd,0xfc,0x04,0x03,0xf7,0xff,0xdf,0xc0,0xf0,0x3f,0x7f,0xff,0xfc,0x3f,0xc3,0xff,0xff,0xff,0xcf,0xff,0x3f,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xdf,0xff,0xff,0xff,0x7f,0xfd,0xff,0xff,0xff,0xf7,0xff,0xff,0xff,0x5f,0xff,0xff,0xff,0xff,0xd5,0x7f,0xff,0xff,0xff,0xf5,0x55,0xff,0xff,0xfd,0xff,0x55,0x5f,0xf7,0xff,0xdf,0xf5,0x55,0xff,0x7f,0xff,0xff,0x55,0x5f,0xff,0xff,0xff,0xf5,0x55,0xff,0xff,0xff,0xff,0x55,0x5f,0xff,0xff,0xff,0xff,0xff,0xff,0xff};


    const uint8_t sun[] = {
    
    0b01111110,
    0b11111111,
    0b11000011,
    0b11000011,
    0b11000011,
    0b11000011,
    0b11111111,
    0b01111110,
};

void pixel (int x, int y) {
    // The byte index into the framebuffer that contains (x, y)
    int idx = (y*160 + x) >> 2;

    // Calculate the bits within the byte that corresponds to our position
    int shift = (x & 0b11) << 1;
    int mask = 0b11 << shift;

    // Use the first DRAW_COLOR as the pixel color
    int palette_color = *DRAW_COLORS & 0b1111;
    if (palette_color == 0) {
        // Transparent
        return;
    }
    int color = (palette_color - 1) & 0b11;

    // Write to the framebuffer
    FRAMEBUFFER[idx] = (uint8_t)(color << shift) | (FRAMEBUFFER[idx] & ~mask);
}

void sensores_mario(){

    int pix_index1 = ((b+16)*160 + a + 4) >> 2;
    int pix_index2 = ((b+16)*160 + a + 12) >> 2;
    int pix_index3 = ((b+14)*160 + a + 1) >> 2;
    int pix_index4 = ((b+14)*160 + a + 15) >> 2;

    if (a % 2 == 0){
        pixPosColor[0] = FRAMEBUFFER[pix_index1] >> 4;
        pixPosColor[1] = FRAMEBUFFER[pix_index2] >> 4;
        pixPosColor[2] = FRAMEBUFFER[pix_index3] >> 4;
        pixPosColor[3] = FRAMEBUFFER[pix_index4] >> 4;
    }
    else {
        pixPosColor[0] = FRAMEBUFFER[pix_index1] & 0b11;
        pixPosColor[1] = FRAMEBUFFER[pix_index2] & 0b11;
        pixPosColor[2] = FRAMEBUFFER[pix_index3] & 0b11;
        pixPosColor[3] = FRAMEBUFFER[pix_index4] & 0b11;
    }

    if (pixPosColor[0] == 0 && pixPosColor[1] == 0 && contador == 0){
        pulo = false;
        b += 1;
        if (gamepad & BUTTON_RIGHT){
            sprite = 9;
        }
        else if (gamepad & BUTTON_LEFT){
            sprite = 10;
        }
    }
    else {
        pulo = true;
        if ((pixPosColor[0] != 0 || pixPosColor[1] != 0) && contador == 0){
            if (sprite == 9){
            sprite = 1;
        }
            else if (sprite == 10){
            sprite = 5;
        }
        }

    }

    if (pixPosColor[2] == 3 && (gamepad & BUTTON_LEFT)){
        mover = false;
        
        a = old_a;
    }
    else if (pixPosColor[3] == 3 && (gamepad & BUTTON_RIGHT)){
        mover = false;
        
        a = old_a;
    }
    else {
        mover = true;
    }

    if (pixPosColor[2] == 1 || pixPosColor[3] == 1){
        morte = true;
    }
    
}

void move(){
    if (mover == true){
    if (gamepad & BUTTON_RIGHT){
        a += 1;
        statex1 += 0.25;
        int x1 = (int)floor(statex1);
        if (x1 % 3 == 1){
            sprite = 2;
            //blitSub(marios,a, b,one_mario, one_mario ,48, 16, marios_len, BLIT_2BPP);
        }
        else if (x1 % 3 == 2){
            sprite = 3;
            //blitSub(marios,a, b,one_mario, one_mario ,32, 0, marios_len, BLIT_2BPP);
        }
        else {
            sprite = 4;
            //blitSub(marios,a, b,one_mario, one_mario ,32, 16, marios_len, BLIT_2BPP);
        }
    }
    if (gamepad & BUTTON_LEFT){
        a -= 1;
        statex2 += 0.25;
        int x2 = (int)floor(statex2);
        if (x2 % 3 == 1){
            //blitSub(marios,a, b,one_mario, one_mario ,48, 16, marios_len, BLIT_2BPP);
            sprite = 6;
        }
        else if (x2 % 3 == 2){
            sprite = 7;
            //blitSub(marios,a, b,one_mario, one_mario ,32, 0, marios_len, BLIT_2BPP);
        }
        else {
            sprite = 8;
            //blitSub(marios,a, b,one_mario, one_mario ,32, 16, marios_len, BLIT_2BPP);
        }
    }
}
    if (!(gamepad) && (gamepad ^ previousGamepad)){
        if (sprite > 1 && sprite < 5){
            sprite = 1;
        }
        else if (sprite > 5 && sprite < 9){
            sprite = 5;
        }
    }

        
}

void jump(){
    if (pressedThisFrame & BUTTON_UP){
        if (contador == 0 && pulo == true){
            contador = 30;
        }
    }
    if (contador > 0){
        contador --;
        b -= 1;
    }
    
    
    if ((sprite == 1 || (gamepad & BUTTON_RIGHT)) && contador > 0){
        sprite = 9;
    }
    if ((sprite == 5 || (gamepad & BUTTON_LEFT))&& contador > 0){
        sprite = 10;
    }

    

}

void move_tela(){
    if (a > 144){
        distancia += 160;
        a = 1;
    }
    if(a < 0){
        distancia -= 160;
        a = 144;
    }
}

void m_inimigo1(int x){

    int coordenadax = (int)(inimigos1[x][0] - (double)distancia);
    int coordenaday = (int)inimigos1[x][1];


    if ((a> coordenadax - 2 && a < coordenadax + 20) && (b == (coordenaday -16))){
        inimigos1[x][2] = 0;
    }

    if (inimigos1[x][2] == 1){
        
        blit(enemies1, coordenadax, coordenaday, 9, 8, BLIT_2BPP);
        if (inimigosestados == 0){
            movinim -=1;
            inimigos1[x][0] -= 0.3;
        }
        else if(inimigosestados == 1){
            movinim += 1;
            inimigos1[x][0] += 0.3;
        }
        if (movinim == -60){
            inimigosestados = 1;
        }
        if (movinim == 60){
            inimigosestados = 0;
        }
    }
    else {
        
        blit(enemies1, coordenadax, coordenaday, 9, 8, BLIT_2BPP | BLIT_FLIP_Y);
        inimigos1[x][1] += 1;
    }

}

void start(){
    PALETTE[0] = 0x7ed5ba;
    PALETTE[1] = 0xffc413;
    PALETTE[2] = 0xe68f66;
    PALETTE[3] = 0x0ec434;
    gamepad = *GAMEPAD1;
    a = 20;
    b = 104;
    *DRAW_COLORS = 0x3421;
    sprite = 1;
    blitSub(marios,a, b,one_mario, one_mario ,32, 16, marios_len, BLIT_2BPP);
    statex1 = 1.0;
    statex2 = 1.0;
    pulo = true;
    mover = true;
    distancia = 0;
    inimigosestados = 0;
    movinim = 0;
    morte = false;
    inimigos1[0][0] = 900;
    inimigos1[0][1] = 102;
    inimigos1[0][2] = 1;
    inimigos1[1][0] = 210;
    inimigos1[1][1] = 92;
    inimigos1[1][2] = 1;
    inimigos1[2][0] = 415;
    inimigos1[2][1] = 112;
    inimigos1[2][2] = 1;
    inimigos1[3][0] = 550;
    inimigos1[3][1] = 82;
    inimigos1[3][2] = 1;
    inimigos1[4][0] = 670;
    inimigos1[4][1] = 122;
    inimigos1[4][2] = 1;
    
    
}

void update () {
    
    gamepad = *GAMEPAD1;
    pressedThisFrame = gamepad & (gamepad ^ previousGamepad);
    
    
    
    //abismo(35, 70, 100);
    *DRAW_COLORS = 2;
    text("Press \x86 to jump!", 10 - distancia, 10);
    text("Press \x84/\x85 to move",10 - distancia, 25);
    text("Jump in the enemies", 165 - distancia, 30);
    *DRAW_COLORS = 0x3421;
    
    if (sprite == 0){
        blitSub(marios,a, b,one_mario, one_mario ,0, 0, marios_len, BLIT_2BPP);
    }
    else if(sprite == 1){
        blitSub(marios,a, b,one_mario, one_mario ,32, 16, marios_len, BLIT_2BPP);
    }
    else if(sprite == 2){
        blitSub(marios,a, b,one_mario, one_mario ,48, 16, marios_len, BLIT_2BPP);
    }
    else if(sprite == 3){
        blitSub(marios,a, b,one_mario, one_mario ,0, 32, marios_len, BLIT_2BPP);
    }
    else if(sprite == 4){
        blitSub(marios,a, b,one_mario, one_mario ,16, 32, marios_len, BLIT_2BPP);
    }
    else if(sprite == 5){
        blitSub(marios,a, b,one_mario, one_mario ,16, 16, marios_len, BLIT_2BPP);
    }
    else if(sprite == 6){
        blitSub(marios,a, b,one_mario, one_mario ,0, 16, marios_len, BLIT_2BPP);
    }
    else if(sprite == 7){
        blitSub(marios,a, b,one_mario, one_mario ,48, 0, marios_len, BLIT_2BPP);
    }
    else if(sprite == 8){
        blitSub(marios,a, b,one_mario, one_mario ,32, 0, marios_len, BLIT_2BPP);
    }
    else if(sprite == 9){
        blitSub(marios,a, b,one_mario, one_mario ,32, 32, marios_len, BLIT_2BPP);
    }
    else if(sprite == 10){
        blitSub(marios,a, b,one_mario, one_mario ,16, 0, marios_len, BLIT_2BPP);
    }
    *DRAW_COLORS = 0x2341;
    //m_inimigo1(0);
    m_inimigo1(1);
    m_inimigo1(2);
    m_inimigo1(3);
    m_inimigo1(4);
    m_inimigo1(0);
    move();
    jump();
    move_tela();
    

    *DRAW_COLORS = 0x2341;
    //blit(inimigo1, 135, 70, enemy1, enemy1, BLIT_2BPP);
    
    
    *DRAW_COLORS = 4;

    rect(-40 - distancia, 120, 100, 40);
    rect(80 - distancia, 120, 120, 40);
    rect(100 - distancia, 100, 20, 20);
    rect(190 - distancia, 100, 50, 60);
    rect(280 - distancia, 125, 90, 35);
    rect(400 -distancia, 120, 50, 40);
    rect(450 - distancia, 95, 50, 70);
    rect(540 - distancia, 90, 70, 70);
    rect(660 - distancia, 130, 40, 30);
    rect(730 - distancia, 105, 20, 60);
    rect(830 - distancia, 120, 20, 40);
    rect(880 - distancia, 110, 50, 50);
    rect(930 - distancia, 90, 60, 80);
    rect(1080 - distancia, 120, 150, 40);
    *DRAW_COLORS = 0x2341;
    blit(castelo, 1180 - distancia, 96, 22, 24, BLIT_2BPP);
    
    
    //rect(90, 100, 40, 60);
    //rect(120, 80, 40, 80);
    
    
    *DRAW_COLORS = 0x03;
    
    //blit(person, 5, 99, 8, 21, BLIT_1BPP);
    *DRAW_COLORS = 0x02;
    
    blit(sun, 140, 10, 8, 8, BLIT_1BPP);
    
    sensores_mario();
    if (b > 144 || morte == true){
        *DRAW_COLORS = 3;
        text("GAME OVER", 40, 40);
        sprite = 0;
        a = old_a;
        b = old_b;
        if (gamepad & BUTTON_1){
            start();
        }
    }

    if (a + distancia >= 1149){
        *DRAW_COLORS = 2;
        text("YOU WIN!", 40, 40);
        
        a = 1150 - distancia;
        
        if (gamepad & BUTTON_1){
            start();
        }
    }

    
    
    

    previousGamepad = gamepad;
    old_a = a;
    old_b = b;
    old_sprite = sprite;
}

